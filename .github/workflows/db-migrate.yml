name: Database migrations

on:
  push:
    branches: 
    - develop

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      flyway_action:
      description: 'Define Flyway action'
      required: true
      default: 'info'
      type: choice
      options:
      - info
      - repair
      - clean
      - migrate
env:
  - DB_NAME: FLYWAY_DB
  - WAREHOUSE_NAME: COMPUTE_WH
  - ROLE: SYSADMIN

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  db-migrate:
    name: Deploy DB
    runs-on: ubuntu-latest
    
    steps:
      - name: Check-out code from repository
        uses: actions/checkout@v3

      - name: Apply migrations
        uses:
        with:
          url: jdbc:snowflake://${{ secrets.account }}.snowflakecomputing.com/?db=${{ env.DB_NAME }}&warehouse=${{ env.WAREHOUSE_NAME }}&role=${{ env.ROLE }}
          user: ${{ secrets.user_name }}
          password: ${{ secrets.db_secret }}
          db_name: ${{ env.DB_NAME }}
          warehouse_name: ${{ env.WAREHOUSE_NAME }}
          locations: filesystem:.db/migrations/
          command: ${{ inputs.flyway_action }}
          disableclean: false
          baselineonmigrate: false
